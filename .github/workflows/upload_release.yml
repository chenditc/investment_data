name: Upload latest data to github release

on:
  workflow_dispatch:
  schedule:
    - cron:  '0 10 * * *'

jobs:

  build:

    runs-on: self-hosted

    steps:
    - name: Get current date
      id: t1
      uses: Kaven-Universe/github-action-current-date-time@v1
      with:
        format: "YYYY-MM-DD"
    - name: Save current date
      id: date
      run: echo "date=${{ steps.t1.outputs.time }}" >> $GITHUB_OUTPUT
    - uses: addnab/docker-run-action@v3
      with:
        registry: docker.io
        image: chenditc/investment_data:latest
        options: --rm --name upload_tar --pull always -v ${{ github.workspace }}:/output -v dolt:/dolt -e HTTP_PROXY -e http_proxy -e HTTPS_PROXY -e https_proxy -e NO_PROXY -e no_proxy
        run: |
          bash -cxe "git config --global http.proxy ${http_proxy} && git config --global https.proxy ${https_proxy} && bash dump_qlib_bin.sh && ls -lh /output/"
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_TOKEN }}
        file: ${{ github.workspace }}/qlib_bin.tar.gz
        asset_name: qlib_bin.tar.gz
        tag: ${{ steps.date.outputs.date }}
        overwrite: true
        body: "Daily update release"
